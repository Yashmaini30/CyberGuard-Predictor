<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberGuard Predictor - Advanced Cybercrime Analytics</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #dc2626;
            --success-color: #059669;
            --warning-color: #d97706;
            --dark-color: #111827;
            --light-color: #f9fafb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
        }

        .stat-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .map-container {
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .alert-panel {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 15px;
        }

        .alert-item {
            border-left: 4px solid var(--warning-color);
            margin-bottom: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .alert-high {
            border-left-color: var(--secondary-color);
        }

        .alert-medium {
            border-left-color: var(--warning-color);
        }

        .alert-low {
            border-left-color: var(--success-color);
        }

        .prediction-form {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary-custom {
            background: var(--primary-color);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
        }

        .prediction-result {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .status-connected {
            background-color: var(--success-color);
        }

        .status-disconnected {
            background-color: var(--secondary-color);
        }

        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.4;
        }

        .heatmap-legend {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Coordinate input styling */
        .form-control[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #6c757d;
        }

        .form-control.is-valid[readonly] {
            background-color: #d1e7dd;
            border-color: #badbcc;
            color: #0f5132;
        }

        .city-selection-hint {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }

        /* City dropdown styling */
        .hover-bg-light:hover {
            background-color: #f8f9fa !important;
        }
        
        .city-item {
            transition: background-color 0.2s ease;
        }
        
        .city-item:hover {
            background-color: #e9ecef;
        }
        
        #cityDropdown {
            border-top: none !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .city-item small {
            font-size: 0.75rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div class="connection-status">
        <div id="wsStatus" class="badge status-disconnected">
            <i class="fas fa-wifi"></i> Disconnected
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--dark-color);">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt"></i> CyberGuard Predictor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#prediction"><i class="fas fa-brain"></i> Prediction</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#analytics"><i class="fas fa-chart-line"></i> Analytics</a>
                    </li>
                    <li class="nav-item" id="enhancedAnalyticsNav" style="display: none;">
                        <a class="nav-link" href="#enhanced-analytics"><i class="fas fa-chart-bar"></i> India Analytics</a>
                    </li>
                    <li class="nav-item" id="notificationsNav" style="display: none;">
                        <a class="nav-link" href="#notifications"><i class="fas fa-bell"></i> Notifications</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/docs" target="_blank"><i class="fas fa-book"></i> API Docs</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> <span id="userName">Guest</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><span class="dropdown-item-text"><small id="userRole">Role: Guest</small></span></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <section id="dashboard" class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold">Advanced Cybercrime Analytics</h1>
                    <p class="lead">Real-time withdrawal location prediction for enhanced cybercrime prevention</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="badge bg-light text-dark p-3">
                        <i class="fas fa-clock"></i> 
                        <span id="currentTime"></span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Statistics Cards -->
    <section class="py-5">
        <div class="container">
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-primary mx-auto mb-3">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3 id="totalPredictions" class="fw-bold">1,247</h3>
                            <p class="text-muted">Total Predictions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-danger mx-auto mb-3">
                                <i class="fas fa-fire"></i>
                            </div>
                            <h3 id="highRiskAlerts" class="fw-bold">89</h3>
                            <p class="text-muted">High Risk Alerts</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-success mx-auto mb-3">
                                <i class="fas fa-bullseye"></i>
                            </div>
                            <h3 id="accuracyRate" class="fw-bold">67.2%</h3>
                            <p class="text-muted">Accuracy Rate</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-warning mx-auto mb-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 id="activeConnections" class="fw-bold">24</h3>
                            <p class="text-muted">Active Connections</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="py-5">
        <div class="container">
            <div class="row g-4">
                <!-- Risk Heatmap -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marked-alt text-primary"></i> 
                                Risk Heatmap - India
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="riskMap" class="map-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Alerts -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-bell text-warning"></i> 
                                Real-time Alerts
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="alertsContainer" class="alert-panel">
                                <!-- Dynamic alerts will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Prediction Section -->
    <section id="prediction" class="py-5 bg-light">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="prediction-form">
                        <h3 class="text-center mb-4">
                            <i class="fas fa-brain text-primary"></i> 
                            Withdrawal Location Prediction
                        </h3>
                        
                        <form id="predictionForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="complaintId" class="form-label">Complaint ID</label>
                                    <input type="text" class="form-control" id="complaintId" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="crimeType" class="form-label">Crime Type</label>
                                    <select class="form-select" id="crimeType" required>
                                        <option value="">Select Crime Type</option>
                                        <option value="phishing">Phishing</option>
                                        <option value="fraud">Financial Fraud</option>
                                        <option value="identity_theft">Identity Theft</option>
                                        <option value="ransomware">Ransomware</option>
                                        <option value="social_engineering">Social Engineering</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="amountLost" class="form-label">Amount Lost (‚Çπ)</label>
                                    <input type="number" class="form-control" id="amountLost" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="urgencyLevel" class="form-label">Urgency Level</label>
                                    <select class="form-select" id="urgencyLevel" required>
                                        <option value="">Select Urgency</option>
                                        <option value="High">High</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="complaintCity" class="form-label">Complaint City</label>
                                    <div class="position-relative">
                                        <input type="text" 
                                               class="form-control" 
                                               id="complaintCity" 
                                               name="complaintCity" 
                                               placeholder="Search any city, town, or location in India..." 
                                               autocomplete="off"
                                               required>
                                        <div id="cityDropdown" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                            <!-- City suggestions will appear here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="complaintLat" class="form-label">Latitude</label>
                                    <input type="number" step="any" class="form-control" id="complaintLat" required readonly>
                                    <div class="form-text">
                                        <small class="text-muted">Auto-filled from city selection</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="complaintLng" class="form-label">Longitude</label>
                                    <input type="number" step="any" class="form-control" id="complaintLng" required readonly>
                                    <div class="form-text">
                                        <small class="text-muted">Auto-filled from city selection</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary-custom">
                                    <i class="fas fa-search"></i> Predict Withdrawal Location
                                </button>
                            </div>
                        </form>

                        <!-- Prediction Results -->
                        <div id="predictionResults" class="prediction-result" style="display: none;">
                            <!-- Dynamic results will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Enhanced India-Wide Analytics Section -->
    <section id="enhanced-analytics" class="py-5" style="display: none;">
        <div class="container">
            <h3 class="text-center mb-5">
                <i class="fas fa-chart-bar text-primary"></i> 
                Comprehensive India-Wide Analytics
            </h3>
            
            <!-- Summary Cards -->
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-danger mx-auto mb-3">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <h3 id="totalIndianCases" class="fw-bold">12,979</h3>
                            <p class="text-muted">Total Cases (India)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-warning mx-auto mb-3">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <h3 id="totalAmountLost" class="fw-bold">‚Çπ456.7Cr</h3>
                            <p class="text-muted">Amount Lost</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-info mx-auto mb-3">
                                <i class="fas fa-map-marked"></i>
                            </div>
                            <h3 id="statesCovered" class="fw-bold">31</h3>
                            <p class="text-muted">States Covered</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-icon bg-success mx-auto mb-3">
                                <i class="fas fa-shield-check"></i>
                            </div>
                            <h3 id="recoveryRate" class="fw-bold">23.7%</h3>
                            <p class="text-muted">Recovery Rate</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">State-wise Distribution</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="stateWiseChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Crime Type Analysis</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="crimeTypeChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Monthly Trends (12 Months)</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="monthlyTrendChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Age Demographics</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="ageDemographicsChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Banking Partners Analysis -->
            <div class="row g-4 mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Banking Partners - Incident Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="bankingPartnersTable">
                                    <thead>
                                        <tr>
                                            <th>Bank Name</th>
                                            <th>Incidents</th>
                                            <th>Amount Lost (‚ÇπCr)</th>
                                            <th>Avg per Case</th>
                                            <th>Trend</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Notifications Management Section -->
    <section id="notifications" class="py-5 bg-light" style="display: none;">
        <div class="container">
            <h3 class="text-center mb-5">
                <i class="fas fa-bell text-primary"></i> 
                Alert Notifications Management
            </h3>
            
            <div class="row g-4">
                <!-- Send Alert Form -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-paper-plane"></i> Send Alert</h6>
                        </div>
                        <div class="card-body">
                            <form id="alertForm">
                                <div class="mb-3">
                                    <label for="alertComplaintId" class="form-label">Complaint ID</label>
                                    <input type="text" class="form-control" id="alertComplaintId" required>
                                </div>
                                <div class="mb-3">
                                    <label for="alertType" class="form-label">Alert Type</label>
                                    <select class="form-select" id="alertType" required>
                                        <option value="">Select Alert Type</option>
                                        <option value="high_risk_withdrawal">High Risk Withdrawal</option>
                                        <option value="suspicious_pattern">Suspicious Pattern</option>
                                        <option value="hotspot_detected">Hotspot Detected</option>
                                        <option value="recovery_opportunity">Recovery Opportunity</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="alertSeverity" class="form-label">Severity</label>
                                    <select class="form-select" id="alertSeverity" required>
                                        <option value="HIGH">High</option>
                                        <option value="MEDIUM">Medium</option>
                                        <option value="LOW">Low</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="alertMessage" class="form-label">Message</label>
                                    <textarea class="form-control" id="alertMessage" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="recipientRole" class="form-label">Recipient</label>
                                    <select class="form-select" id="recipientRole" required>
                                        <option value="both">Both LEA & Bank</option>
                                        <option value="lea">LEA Only</option>
                                        <option value="bank">Bank Only</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="alertCity" class="form-label">City</label>
                                    <input type="text" class="form-control" id="alertCity" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-bell"></i> Send Alert
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Notification History -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-history"></i> Notification History</h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadNotificationHistory()">
                                    <i class="fas fa-refresh"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="notificationHistory" style="max-height: 400px; overflow-y: auto;">
                                <!-- Dynamic notification history will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Analytics Section -->
    <section id="analytics" class="py-5">
        <div class="container">
            <h3 class="text-center mb-5">
                <i class="fas fa-chart-line text-primary"></i> 
                System Analytics
            </h3>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Weekly Trend</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="trendChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Risk Distribution</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="riskChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p>&copy; 2025 CyberGuard Predictor - SIH 2025 Problem Statement ID 25257</p>
            <p class="small">Advanced Cybercrime Withdrawal Location Prediction System</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Local Scripts -->
    <script src="/static/assets/js/main.js"></script>
    <script src="/static/assets/js/index.js"></script>

    <script>
        let map;
        let websocket;
        let predictionSocket;
        let enhancedChartsInitialized = false;

        // User authentication and role management
        function checkAuthAndSetupUI() {
            const userRole = localStorage.getItem('userRole');
            const userName = localStorage.getItem('userName');
            const userToken = localStorage.getItem('userToken');

            if (!userRole || !userName || !userToken) {
                // Redirect to login if not authenticated
                window.location.href = '/login';
                return;
            }

            // Update UI based on user role
            document.getElementById('userName').textContent = userName;
            document.getElementById('userRole').textContent = `Role: ${userRole.toUpperCase()}`;

            // Show role-specific navigation items
            if (userRole === 'lea') {
                document.getElementById('enhancedAnalyticsNav').style.display = 'block';
                document.getElementById('notificationsNav').style.display = 'block';
            } else if (userRole === 'bank') {
                document.getElementById('enhancedAnalyticsNav').style.display = 'block';
                // Banks can view analytics but limited notification access
            }
        }

        function logout() {
            // Clear local storage
            localStorage.removeItem('userRole');
            localStorage.removeItem('userName');
            localStorage.removeItem('userToken');
            
            // Redirect to login
            window.location.href = '/login';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            checkAuthAndSetupUI();
            initializeMap();
            initializeWebSocket();
            updateCurrentTime();
            loadSystemStats();
            setupPredictionForm();
            setupCitySearch();
            initializeCharts();
            await initializeGeographicChart(); // Make this async
            setupNavigation();
            setupAlertForm();
            
            // Update time every minute
            setInterval(updateCurrentTime, 60000);
            // Update stats every 30 seconds
            setInterval(loadSystemStats, 30000);
            // Update charts every 2 minutes
            setInterval(updateCharts, 120000);
            // Update geographic data every 5 minutes
            setInterval(initializeGeographicChart, 300000);
        });

        // Navigation setup for new sections
        function setupNavigation() {
            // Enhanced Analytics navigation
            document.querySelector('a[href="#enhanced-analytics"]')?.addEventListener('click', function(e) {
                e.preventDefault();
                showEnhancedAnalytics();
            });

            // Notifications navigation
            document.querySelector('a[href="#notifications"]')?.addEventListener('click', function(e) {
                e.preventDefault();
                showNotifications();
            });
        }

        // Show Enhanced Analytics section
        async function showEnhancedAnalytics() {
            // Hide other sections
            document.getElementById('analytics').style.display = 'none';
            document.getElementById('prediction').style.display = 'none';
            document.getElementById('notifications').style.display = 'none';
            
            // Show enhanced analytics
            document.getElementById('enhanced-analytics').style.display = 'block';
            
            // Load enhanced analytics data if not already loaded
            if (!enhancedChartsInitialized) {
                await loadEnhancedAnalytics();
                enhancedChartsInitialized = true;
            }
        }

        // Show Notifications section
        function showNotifications() {
            // Hide other sections
            document.getElementById('analytics').style.display = 'none';
            document.getElementById('prediction').style.display = 'none';
            document.getElementById('enhanced-analytics').style.display = 'none';
            
            // Show notifications
            document.getElementById('notifications').style.display = 'block';
            
            // Load notification history
            loadNotificationHistory();
        }

        // Load Enhanced Analytics
        async function loadEnhancedAnalytics() {
            try {
                const response = await fetch('/enhanced-analytics');
                const data = await response.json();
                
                // Update summary cards
                document.getElementById('totalIndianCases').textContent = data.summary.total_cases.toLocaleString();
                document.getElementById('totalAmountLost').textContent = `‚Çπ${data.summary.total_amount_lost}Cr`;
                document.getElementById('statesCovered').textContent = data.summary.states_covered;
                document.getElementById('recoveryRate').textContent = `${data.recovery_statistics.recovery_rate}%`;
                
                // Initialize enhanced charts
                initializeStateWiseChart(data.state_wise_distribution);
                initializeCrimeTypeChart(data.crime_type_analysis);
                initializeMonthlyTrendChart(data.monthly_trends);
                initializeAgeDemographicsChart(data.age_demographics);
                initializeBankingPartnersTable(data.banking_partners);
                
                console.log('üìä Enhanced analytics loaded successfully');
                
            } catch (error) {
                console.error('Failed to load enhanced analytics:', error);
            }
        }

        // Initialize State-wise Chart
        function initializeStateWiseChart(stateData) {
            const ctx = document.getElementById('stateWiseChart').getContext('2d');
            const states = Object.keys(stateData).slice(0, 10); // Top 10 states
            const incidents = states.map(state => stateData[state].incidents);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: states,
                    datasets: [{
                        label: 'Incidents',
                        data: incidents,
                        backgroundColor: 'rgba(30, 64, 175, 0.8)',
                        borderColor: 'rgba(30, 64, 175, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 States by Cybercrime Incidents'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Initialize Crime Type Chart
        function initializeCrimeTypeChart(crimeData) {
            const ctx = document.getElementById('crimeTypeChart').getContext('2d');
            const crimeTypes = Object.keys(crimeData);
            const cases = crimeTypes.map(type => crimeData[type].cases);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: crimeTypes,
                    datasets: [{
                        data: cases,
                        backgroundColor: [
                            '#dc2626', '#d97706', '#059669', '#1e40af', '#7c3aed', '#be185d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Crime Type Distribution'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize Monthly Trend Chart
        function initializeMonthlyTrendChart(monthlyData) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            const months = monthlyData.map(item => item.month);
            const totalCases = monthlyData.map(item => item.total_cases);
            const highRisk = monthlyData.map(item => item.high_risk);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Total Cases',
                        data: totalCases,
                        borderColor: '#1e40af',
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        fill: true
                    }, {
                        label: 'High Risk',
                        data: highRisk,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '12-Month Trend Analysis'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Initialize Age Demographics Chart
        function initializeAgeDemographicsChart(ageData) {
            const ctx = document.getElementById('ageDemographicsChart').getContext('2d');
            const ageGroups = Object.keys(ageData);
            const percentages = ageGroups.map(group => ageData[group].percentage);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ageGroups,
                    datasets: [{
                        label: 'Percentage',
                        data: percentages,
                        backgroundColor: 'rgba(5, 150, 105, 0.8)',
                        borderColor: 'rgba(5, 150, 105, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Age Group Distribution (%)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 40
                        }
                    }
                }
            });
        }

        // Initialize Banking Partners Table
        function initializeBankingPartnersTable(bankData) {
            const tbody = document.querySelector('#bankingPartnersTable tbody');
            tbody.innerHTML = '';
            
            Object.keys(bankData).forEach(bankName => {
                const bank = bankData[bankName];
                const avgPerCase = (bank.amount * 10000000 / bank.incidents).toLocaleString(); // Convert crores to rupees
                
                const row = `
                    <tr>
                        <td><strong>${bankName}</strong></td>
                        <td>${bank.incidents.toLocaleString()}</td>
                        <td>‚Çπ${bank.amount}</td>
                        <td>‚Çπ${avgPerCase}</td>
                        <td><span class="badge bg-warning">Monitoring</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Setup Alert Form
        function setupAlertForm() {
            document.getElementById('alertForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const alertData = {
                    alert_id: `AL${Date.now()}`,
                    complaint_id: document.getElementById('alertComplaintId').value,
                    alert_type: document.getElementById('alertType').value,
                    message: document.getElementById('alertMessage').value,
                    severity: document.getElementById('alertSeverity').value,
                    recipient_role: document.getElementById('recipientRole').value,
                    city: document.getElementById('alertCity').value,
                    phone_number: "+91-9876543210", // Demo phone
                    email: "demo@cyberguard.gov.in" // Demo email
                };

                try {
                    const response = await fetch('/send-alert', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                        },
                        body: JSON.stringify(alertData)
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        alert('Alert sent successfully!');
                        document.getElementById('alertForm').reset();
                        loadNotificationHistory(); // Refresh history
                    } else {
                        alert('Failed to send alert');
                    }
                } catch (error) {
                    console.error('Alert sending failed:', error);
                    alert('Failed to send alert');
                }
            });
        }

        // Load Notification History
        async function loadNotificationHistory() {
            try {
                const response = await fetch('/notification-history');
                const data = await response.json();
                
                const historyDiv = document.getElementById('notificationHistory');
                historyDiv.innerHTML = '';
                
                if (data.notifications.length === 0) {
                    historyDiv.innerHTML = '<p class="text-muted text-center">No notifications found</p>';
                    return;
                }
                
                data.notifications.forEach(notification => {
                    const severityClass = notification.severity === 'HIGH' ? 'danger' : 
                                        notification.severity === 'MEDIUM' ? 'warning' : 'info';
                    
                    const notificationHtml = `
                        <div class="alert alert-${severityClass} alert-dismissible fade show" role="alert">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="alert-heading">${notification.alert_type.replace('_', ' ').toUpperCase()}</h6>
                                    <p class="mb-1">${notification.message}</p>
                                    <small><strong>Complaint:</strong> ${notification.complaint_id} | 
                                           <strong>Time:</strong> ${new Date(notification.timestamp).toLocaleString()}</small>
                                </div>
                                <span class="badge bg-${severityClass}">${notification.severity}</span>
                            </div>
                        </div>
                    `;
                    historyDiv.innerHTML += notificationHtml;
                });
                
            } catch (error) {
                console.error('Failed to load notification history:', error);
                document.getElementById('notificationHistory').innerHTML = 
                    '<p class="text-danger text-center">Failed to load notification history</p>';
            }
        }

        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('riskMap').setView([20.5937, 78.9629], 5); // Center on India
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Load risk heatmap data
            loadRiskHeatmap();
        }

        // Load risk heatmap from API
        async function loadRiskHeatmap() {
            try {
                const response = await fetch('/risk-heatmap');
                const heatmapData = await response.json();
                
                heatmapData.forEach(point => {
                    const color = point.risk_score > 0.8 ? '#dc2626' : 
                                 point.risk_score > 0.5 ? '#d97706' : '#059669';
                    
                    const marker = L.circleMarker([point.lat, point.lng], {
                        radius: Math.max(5, point.incident_count * 2),
                        fillColor: color,
                        color: color,
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    }).addTo(map);

                    marker.bindPopup(`
                        <div>
                            <h6>${point.city}</h6>
                            <p><strong>Risk Score:</strong> ${(point.risk_score * 100).toFixed(1)}%</p>
                            <p><strong>Incidents:</strong> ${point.incident_count}</p>
                        </div>
                    `);
                });
                
                console.log('üó∫Ô∏è Risk heatmap loaded with', heatmapData.length, 'points');
                
            } catch (error) {
                console.error('Failed to load heatmap data:', error);
                
                // Fallback: Use geographic data if available
                if (window.geographicData && window.geographicData.length > 0) {
                    console.log('üó∫Ô∏è Using geographic data as heatmap fallback');
                    
                    // Add some sample coordinates for major Indian cities
                    const cityCoordinates = {
                        'Delhi': [28.6139, 77.2090],
                        'Mumbai': [19.0760, 72.8777],
                        'Maharashtra': [19.7515, 75.7139],
                        'Karnataka': [15.3173, 75.7139],
                        'Bangalore': [12.9716, 77.5946],
                        'Chennai': [13.0827, 80.2707],
                        'Tamil Nadu': [11.1271, 78.6569],
                        'Kolkata': [22.5726, 88.3639],
                        'West Bengal': [22.9868, 87.8550],
                        'Hyderabad': [17.3850, 78.4867],
                        'Telangana': [18.1124, 79.0193],
                        'Gujarat': [23.0225, 72.5714],
                        'Uttar Pradesh': [26.8467, 80.9462],
                        'Rajasthan': [27.0238, 74.2179],
                        'Punjab': [31.1471, 75.3412]
                    };
                    
                    window.geographicData.forEach(location => {
                        const coords = cityCoordinates[location.city];
                        if (coords) {
                            const color = location.risk > 0.8 ? '#dc2626' : 
                                         location.risk > 0.5 ? '#d97706' : '#059669';
                            
                            const marker = L.circleMarker(coords, {
                                radius: Math.max(8, Math.min(location.incidents / 50, 20)),
                                fillColor: color,
                                color: color,
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0.6
                            }).addTo(map);

                            marker.bindPopup(`
                                <div>
                                    <h6>${location.city}</h6>
                                    <p><strong>Risk Score:</strong> ${(location.risk * 100).toFixed(1)}%</p>
                                    <p><strong>Incidents:</strong> ${location.incidents}</p>
                                    ${location.amount_lost ? `<p><strong>Amount Lost:</strong> ‚Çπ${location.amount_lost}Cr</p>` : ''}
                                </div>
                            `);
                        }
                    });
                }
            }
        }

        // Initialize WebSocket connections
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/lea-alerts`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                document.getElementById('wsStatus').className = 'badge status-connected';
                document.getElementById('wsStatus').innerHTML = '<i class="fas fa-wifi"></i> Connected';
                console.log('WebSocket connected');
            };

            websocket.onmessage = function(event) {
                const alert = JSON.parse(event.data);
                addAlertToPanel(alert);
            };

            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                document.getElementById('wsStatus').className = 'badge status-disconnected';
                document.getElementById('wsStatus').innerHTML = '<i class="fas fa-wifi"></i> Error';
            };

            websocket.onclose = function(event) {
                document.getElementById('wsStatus').className = 'badge status-disconnected';
                document.getElementById('wsStatus').innerHTML = '<i class="fas fa-wifi"></i> Disconnected';
                
                // Attempt to reconnect after 5 seconds
                setTimeout(initializeWebSocket, 5000);
            };
        }

        // Add alert to the alerts panel
        function addAlertToPanel(alert) {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertElement = document.createElement('div');
            alertElement.className = `alert-item alert-${alert.severity.toLowerCase()}`;
            
            alertElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${alert.alert_type.replace('_', ' ').toUpperCase()}</h6>
                        <p class="mb-1">${alert.message}</p>
                        <small class="text-muted">Complaint: ${alert.complaint_id}</small>
                    </div>
                    <span class="badge bg-${alert.severity.toLowerCase() === 'high' ? 'danger' : 'warning'}">
                        ${alert.severity}
                    </span>
                </div>
            `;
            
            alertsContainer.insertBefore(alertElement, alertsContainer.firstChild);
            
            // Keep only latest 10 alerts
            while (alertsContainer.children.length > 10) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString();
        }

        // Load system statistics
        async function loadSystemStats() {
            try {
                const response = await fetch('/system-stats');
                const stats = await response.json();
                
                document.getElementById('totalPredictions').textContent = stats.predictions_last_7_days || '0';
                document.getElementById('highRiskAlerts').textContent = stats.high_risk_alerts || '0';
                document.getElementById('accuracyRate').textContent = stats.accuracy_rate || '0%';
                document.getElementById('activeConnections').textContent = 
                    (stats.lea_connections + stats.bank_connections) || '0';
            } catch (error) {
                console.error('Failed to load system stats:', error);
            }
        }

        // Setup city search with OpenStreetMap integration
        function setupCitySearch() {
            const cityInput = document.getElementById('complaintCity');
            const cityDropdown = document.getElementById('cityDropdown');
            let searchTimeout;
            let selectedCityData = null;

            // Focus shows helpful text
            cityInput.addEventListener('focus', function() {
                if (cityInput.value.trim() === '') {
                    cityDropdown.innerHTML = '<div class="p-2 text-muted"><i class="fas fa-info-circle"></i> Start typing to search for any city, town, or location in India...</div>';
                    cityDropdown.style.display = 'block';
                }
            });

            // Search cities as user types
            cityInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    if (query.length === 0) {
                        showPopularCities();
                    } else {
                        cityDropdown.style.display = 'none';
                    }
                    return;
                }

                // Show loading
                cityDropdown.innerHTML = '<div class="p-2 text-muted"><i class="fas fa-spinner fa-spin"></i> Searching cities...</div>';
                cityDropdown.style.display = 'block';

                // Debounce search
                searchTimeout = setTimeout(async () => {
                    try {
                        const suggestions = await getCitySuggestions(query);
                        displayCitySuggestions(suggestions);
                    } catch (error) {
                        console.error('City search failed:', error);
                        cityDropdown.innerHTML = '<div class="p-2 text-danger"><i class="fas fa-exclamation-triangle"></i> Search failed. Please try again.</div>';
                    }
                }, 300);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!cityInput.contains(e.target) && !cityDropdown.contains(e.target)) {
                    cityDropdown.style.display = 'none';
                }
            });

            // Handle city selection
            cityDropdown.addEventListener('click', function(e) {
                const cityItem = e.target.closest('.city-item');
                if (cityItem) {
                    const cityName = cityItem.dataset.cityName;
                    if (cityItem.dataset.lat && cityItem.dataset.lng) {
                        const lat = parseFloat(cityItem.dataset.lat);
                        const lng = parseFloat(cityItem.dataset.lng);
                        const state = cityItem.dataset.state;
                        selectCity(cityName, lat, lng, state);
                    } else {
                        selectCity(cityName);
                    }
                }
            });

            function displayCitySuggestions(suggestions) {
                if (suggestions.length === 0) {
                    cityDropdown.innerHTML = '<div class="p-2 text-muted">No cities found. Try a different search term.</div>';
                    return;
                }

                let html = '<div class="p-2"><strong class="text-muted"><i class="fas fa-search"></i> Search Results</strong></div>';
                
                suggestions.forEach(city => {
                    html += `<div class="city-item p-2 border-bottom cursor-pointer hover-bg-light" 
                                  data-city-name="${city.name}" 
                                  data-lat="${city.lat}" 
                                  data-lng="${city.lng}" 
                                  data-state="${city.state}"
                                  style="cursor: pointer;">
                                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                <strong>${city.name}</strong>${city.state ? ', ' + city.state : ''}
                                <small class="text-muted d-block">${city.fullName}</small>
                             </div>`;
                });
                
                cityDropdown.innerHTML = html;
                cityDropdown.style.display = 'block';
            }

            async function selectCity(cityName, lat = null, lng = null, state = null) {
                cityInput.value = cityName;
                cityDropdown.style.display = 'none';

                // Show loading state
                document.getElementById('complaintLat').value = 'Loading...';
                document.getElementById('complaintLng').value = 'Loading...';

                try {
                    let coordinates;
                    if (lat && lng) {
                        coordinates = { lat, lng, state };
                    } else {
                        // Fetch coordinates from OpenStreetMap
                        coordinates = await getCityCoordinates(cityName);
                    }

                    if (coordinates) {
                        selectedCityData = coordinates;
                        document.getElementById('complaintLat').value = coordinates.lat.toFixed(6);
                        document.getElementById('complaintLng').value = coordinates.lng.toFixed(6);
                        
                        // Show success feedback
                        showCitySelectionFeedback(cityName, coordinates);
                        
                        // Update map if available
                        if (typeof map !== 'undefined' && map) {
                            map.setView([coordinates.lat, coordinates.lng], 12);
                            
                            // Add marker
                            if (window.cityMarker) {
                                map.removeLayer(window.cityMarker);
                            }
                            window.cityMarker = L.marker([coordinates.lat, coordinates.lng])
                                .addTo(map)
                                .bindPopup(`${cityName}<br>Lat: ${coordinates.lat.toFixed(6)}, Lng: ${coordinates.lng.toFixed(6)}`)
                                .openPopup();
                        }
                    } else {
                        throw new Error('Coordinates not found');
                    }
                } catch (error) {
                    console.error('Failed to get coordinates:', error);
                    document.getElementById('complaintLat').value = '';
                    document.getElementById('complaintLng').value = '';
                    showCityErrorMessage(cityName);
                }
            }

            // Search cities using OpenStreetMap Nominatim API
            async function getCitySuggestions(query) {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=in&limit=10&addressdetails=1`;
                
                try {
                    const response = await fetch(nominatimUrl, {
                        headers: {
                            'User-Agent': 'CyberGuard-Predictor/1.0'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Process and format the results
                    return data.map(item => ({
                        name: item.display_name.split(',')[0], // First part is usually the city name
                        fullName: item.display_name,
                        lat: parseFloat(item.lat),
                        lng: parseFloat(item.lon),
                        state: item.address?.state || '',
                        type: item.type,
                        importance: item.importance || 0
                    })).sort((a, b) => b.importance - a.importance); // Sort by importance
                    
                } catch (error) {
                    console.error('Error fetching city suggestions:', error);
                    return [];
                }
            }

            function showCityErrorMessage(cityName) {
                const latInput = document.getElementById('complaintLat');
                const lngInput = document.getElementById('complaintLng');
                
                // Add error styling
                latInput.classList.add('is-invalid');
                lngInput.classList.add('is-invalid');
                
                // Show error toast
                const toastHtml = `
                    <div class="toast align-items-center text-bg-danger border-0 position-fixed top-0 end-0 m-3" role="alert" style="z-index: 1055;">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Could not find coordinates for "${cityName}". Please try a different city.
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', toastHtml);
                const toast = new bootstrap.Toast(document.querySelector('.toast:last-child'));
                toast.show();
                
                // Remove error styling after 3 seconds
                setTimeout(() => {
                    latInput.classList.remove('is-invalid');
                    lngInput.classList.remove('is-invalid');
                }, 3000);
                
                console.error(`‚ùå Failed to geocode: ${cityName}`);
            }
        }

        // Show feedback when city is selected
        function showCitySelectionFeedback(cityName, coordinates) {
            const latInput = document.getElementById('complaintLat');
            const lngInput = document.getElementById('complaintLng');
            
            // Add success styling
            latInput.classList.add('is-valid');
            lngInput.classList.add('is-valid');
            
            // Show success toast
            const toastHtml = `
                <div class="toast align-items-center text-bg-success border-0 position-fixed top-0 end-0 m-3" role="alert" style="z-index: 1055;">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>${cityName}</strong> located successfully!
                            <br><small>Lat: ${coordinates.lat.toFixed(6)}, Lng: ${coordinates.lng.toFixed(6)}</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            const toast = new bootstrap.Toast(document.querySelector('.toast:last-child'));
            toast.show();
            
            // Remove success styling after 3 seconds
            setTimeout(() => {
                latInput.classList.remove('is-valid');
                lngInput.classList.remove('is-valid');
            }, 3000);
            
            console.log(`‚úÖ Geocoded ${cityName}: ${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}`);
        }

        // Setup prediction form
        function setupPredictionForm() {
            document.getElementById('predictionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    complaint_id: document.getElementById('complaintId').value,
                    crime_type: document.getElementById('crimeType').value,
                    amount_lost: parseFloat(document.getElementById('amountLost').value),
                    urgency_level: document.getElementById('urgencyLevel').value,
                    complaint_city: document.getElementById('complaintCity').value,
                    complaint_lat: parseFloat(document.getElementById('complaintLat').value),
                    complaint_lng: parseFloat(document.getElementById('complaintLng').value)
                };

                // Validate that a city is selected
                if (!formData.complaint_city) {
                    alert('Please select a city from the dropdown.');
                    return;
                }

                // Validate coordinates are populated
                if (!formData.complaint_lat || !formData.complaint_lng) {
                    alert('Coordinates not found for selected city. Please try another city.');
                    return;
                }

                try {
                    const response = await fetch('/predict-withdrawal-location', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    console.log('üéØ RECEIVED FROM MODEL:', result);
                    displayPredictionResults(result);
                } catch (error) {
                    console.error('Prediction failed:', error);
                    alert('Prediction failed. Please try again.');
                }
            });
        }

        // Display prediction results
        function displayPredictionResults(result) {
            const resultsDiv = document.getElementById('predictionResults');
            
            resultsDiv.innerHTML = `
                <h5 class="text-center mb-3">
                    <i class="fas fa-map-marker-alt text-primary"></i> 
                    Prediction Results
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6>Predicted Location</h6>
                                <p class="mb-0">
                                    <strong>Lat:</strong> ${result.predicted_withdrawal_lat.toFixed(4)}<br>
                                    <strong>Lng:</strong> ${result.predicted_withdrawal_lng.toFixed(4)}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6>Risk Assessment</h6>
                                <p class="mb-0">
                                    <span class="badge bg-${result.risk_level.toLowerCase() === 'high' ? 'danger' : 
                                                               result.risk_level.toLowerCase() === 'medium' ? 'warning' : 'success'} fs-6">
                                        ${result.risk_level}
                                    </span><br>
                                    <small>Probability: ${(result.withdrawal_probability * 100).toFixed(1)}%</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6>Predicted Timing</h6>
                                <p class="mb-0">
                                    <strong>${result.predicted_hours_to_withdrawal}</strong> hours<br>
                                    <small>Alert Radius: ${result.alert_radius_km} km</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6>Confidence Score</h6>
                                <p class="mb-0">
                                    <strong>${(result.confidence_score * 100).toFixed(1)}%</strong><br>
                                    <small>Model reliability</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            
            // Add marker to map
            if (map) {
                const marker = L.marker([result.predicted_withdrawal_lat, result.predicted_withdrawal_lng])
                    .addTo(map)
                    .bindPopup(`
                        <div>
                            <h6>Predicted Withdrawal Location</h6>
                            <p><strong>Complaint ID:</strong> ${result.complaint_id}</p>
                            <p><strong>Risk Level:</strong> ${result.risk_level}</p>
                            <p><strong>Probability:</strong> ${(result.withdrawal_probability * 100).toFixed(1)}%</p>
                        </div>
                    `);
                
                map.setView([result.predicted_withdrawal_lat, result.predicted_withdrawal_lng], 10);
                marker.openPopup();
            }
        }

        // Initialize Analytics Charts
        async function initializeCharts() {
            try {
                // Fetch real analytics data
                const response = await fetch('/analytics-data');
                const analytics = await response.json();
                
                // Weekly Trend Chart
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                const trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: analytics.weekly_trend.labels,
                        datasets: [{
                            label: 'Cybercrime Reports',
                            data: analytics.weekly_trend.complaints,
                            borderColor: '#1e40af',
                            backgroundColor: 'rgba(30, 64, 175, 0.1)',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'High Risk Alerts',
                            data: analytics.weekly_trend.high_risk,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Weekly Cybercrime Trends'
                            }
                        }
                    }
                });

                // Risk Distribution Chart
                const riskCtx = document.getElementById('riskChart').getContext('2d');
                const riskChart = new Chart(riskCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                        datasets: [{
                            data: [analytics.risk_distribution.high, analytics.risk_distribution.medium, analytics.risk_distribution.low],
                            backgroundColor: [
                                '#dc2626',
                                '#d97706', 
                                '#059669'
                            ],
                            borderColor: [
                                '#dc2626',
                                '#d97706',
                                '#059669'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            title: {
                                display: true,
                                text: 'Risk Level Distribution'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                console.log('üìä Analytics charts initialized with real data');
                
                // Store chart references for updates
                window.dashboardCharts = { trendChart, riskChart };
                
            } catch (error) {
                console.error('Failed to load analytics data:', error);
                // Fall back to demo data
                initializeChartsWithDemoData();
            }
        }

        // Fallback function with demo data
        function initializeChartsWithDemoData() {
            // Weekly Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Cybercrime Reports',
                        data: [45, 52, 38, 67, 73, 29, 41],
                        borderColor: '#1e40af',
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'High Risk Alerts',
                        data: [12, 15, 8, 22, 28, 7, 13],
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Weekly Cybercrime Trends (Demo Data)'
                        }
                    }
                }
            });

            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            const riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                    datasets: [{
                        data: [89, 156, 203],
                        backgroundColor: [
                            '#dc2626',
                            '#d97706', 
                            '#059669'
                        ],
                        borderColor: [
                            '#dc2626',
                            '#d97706',
                            '#059669'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Risk Level Distribution (Demo Data)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            console.log('üìä Analytics charts initialized with demo data');
        }

        // Update charts with fresh data
        async function updateCharts() {
            try {
                const response = await fetch('/analytics-data');
                const analytics = await response.json();
                
                if (window.dashboardCharts) {
                    // Update trend chart
                    if (window.dashboardCharts.trendChart) {
                        window.dashboardCharts.trendChart.data.datasets[0].data = analytics.weekly_trend.complaints;
                        window.dashboardCharts.trendChart.data.datasets[1].data = analytics.weekly_trend.high_risk;
                        window.dashboardCharts.trendChart.update();
                    }
                    
                    // Update risk distribution chart
                    if (window.dashboardCharts.riskChart) {
                        window.dashboardCharts.riskChart.data.datasets[0].data = [
                            analytics.risk_distribution.high,
                            analytics.risk_distribution.medium,
                            analytics.risk_distribution.low
                        ];
                        window.dashboardCharts.riskChart.update();
                    }
                    
                    console.log('üìä Charts updated with fresh data');
                }
            } catch (error) {
                console.error('Failed to update charts:', error);
            }
        }

        // Initialize Geographic Distribution Chart
        async function initializeGeographicChart() {
            try {
                // Fetch real geographic data from enhanced analytics API
                const response = await fetch('/enhanced-analytics');
                const data = await response.json();
                
                // Process state-wise data into city format for compatibility
                const stateData = data.state_wise_distribution || {};
                const geoData = Object.keys(stateData).map(state => ({
                    city: state,
                    incidents: stateData[state].incidents || 0,
                    risk: stateData[state].risk_score || 0,
                    amount_lost: stateData[state].amount_lost || 0
                })).sort((a, b) => b.incidents - a.incidents); // Sort by incidents descending
                
                console.log('üó∫Ô∏è Real geographic data loaded:', geoData.length, 'states/regions');
                
                // Store for potential chart visualization
                window.geographicData = geoData;
                
                return geoData;
                
            } catch (error) {
                console.error('Failed to load geographic data:', error);
                
                // Fallback to analytics-data endpoint
                try {
                    const fallbackResponse = await fetch('/analytics-data');
                    const fallbackData = await fallbackResponse.json();
                    const geoData = fallbackData.geographic_data || [];
                    
                    console.log('üó∫Ô∏è Fallback geographic data loaded:', geoData);
                    window.geographicData = geoData;
                    return geoData;
                    
                } catch (fallbackError) {
                    console.error('Both geographic data sources failed:', fallbackError);
                    
                    // Emergency fallback with demo data
                    const demoData = [
                        { city: 'Delhi', incidents: 67, risk: 0.85 },
                        { city: 'Mumbai', incidents: 52, risk: 0.75 },
                        { city: 'Bangalore', incidents: 41, risk: 0.65 },
                        { city: 'Chennai', incidents: 38, risk: 0.68 },
                        { city: 'Kolkata', incidents: 35, risk: 0.70 },
                        { city: 'Hyderabad', incidents: 29, risk: 0.72 }
                    ];
                    
                    console.log('üó∫Ô∏è Using emergency demo data');
                    window.geographicData = demoData;
                    return demoData;
                }
            }
        }

        // Sample data for demo alerts
        function loadSampleAlerts() {
            const sampleAlerts = [
                {
                    alert_id: "alert_001",
                    complaint_id: "CG2025001",
                    alert_type: "high_risk",
                    message: "HIGH RISK: Withdrawal predicted in Delhi region within 6 hours",
                    severity: "HIGH",
                    timestamp: new Date().toISOString()
                },
                {
                    alert_id: "alert_002", 
                    complaint_id: "CG2025002",
                    alert_type: "withdrawal_predicted",
                    message: "MEDIUM RISK: Potential withdrawal location identified in Mumbai",
                    severity: "MEDIUM",
                    timestamp: new Date().toISOString()
                }
            ];
            
            sampleAlerts.forEach(alert => addAlertToPanel(alert));
        }

        // Load sample alerts on startup
        setTimeout(loadSampleAlerts, 2000);
    </script>
</body>
</html>